#!/usr/bin/env ruby
require 'fileutils'
require 'open3'

# path to your application root.
APP_ROOT = File.expand_path('..', __dir__)

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

FileUtils.chdir APP_ROOT do
  # This script is a way to setup or update your development environment automatically.
  # This script is idempotent, so that you can run it at anytime and get an expectable outcome.
  # Add necessary setup steps to this file.
  puts "\n== Copying sample files =="
  %W[
    .env.sample
  ].each do |sample_path|
    target_path = sample_path.sub(/\.sample$/, "")
    next if File.exist?(target_path)
    FileUtils.cp(sample_path, target_path)
    puts "created #{target_path}"
  end

  puts "\n== ensuring database initialization requirements are met =="
  pg_pass_line = File.foreach(".env").detect { |line| /^POSTGRES_PASSWORD/.match?(line) }
  pg_pass = pg_pass_line.strip.split("=")[1]
  if pg_pass.nil? || pg_pass.empty?
    puts "set POSTGRES_PASSWORD in .env and rerun bin/setup"
    exit
  end

  puts "\n== Looking for docker-compose =="
  unless system("which docker-compose > /dev/null")
    puts "docker-compose could not be found"
    exit
  end

  puts "\n== Building Docker container =="
  system! "docker-compose build"

  # TRICKY: this this seems to also allow the database image to do some initailization work which
  # otherwise can cause `rails db:create` to fail if it is run too soon after the database image
  # starts
  puts "\n== Initializing database image =="
  puts "NOTE: you may need to interrupt with ^C if Bad Things Happen"
  Open3.popen2("docker-compose up db") do |_, out, thread|
    out.each do |line|
      puts line
      break if /database system is ready to accept connections/.match?(line)
    end
    Process.kill("KILL", thread.pid)
  end
  system("docker-compose down")

  puts "\n== Setting up the database =="
  system! "docker-compose run web bundle exec rails db:setup"

  puts "\n== Running first-time migrations =="
  system! 'docker-compose run web bundle exec rails db:migrate'

  puts "\n== Removing old logs and tempfiles =="
  system! 'docker-compose run web bundle exec rails log:clear tmp:clear'

  puts "\n==    Setup finished successfully!     =="
  puts   "== `docker-compose up` to start server =="
  puts   "==    0.0.0.0:3000 to visit homepage   =="
end
